# 开放平台支付说明文档

## 支付业务流程

### 1 有屏音箱支付业务流程

![](./pic/pay1.png)

### 2 无屏音箱支付业务流程

![](./pic/pay2.png)

### 3 有屏音箱支付成功跳转流程

![](./pic/pay3.png)

## 接口说明

**注意事项：**

**1. 该文档中的请求接口都需要安全验证，验证方法见：[TSK-RSA2签名方法](./security.md)，目前只支持TSK-RSA2算法。**

**2. TSK平台会对每次请求或回复，进行相应的签名或验签。**

**3. 接口参数有可能扩展，请做好兼容**



### 1 创建订单

用户下单时，叮当调用合作方提供的接口创建订单，合作商需要接收处理，并返回应答。

**接口链接：合作方提供**

**请求方法：post**

 **参数说明：json格式**

| 参数            | 必填 | 描述                   | 类型         |最大长度|
| --------------- | ---- | ---------------------- | ------------ |--------------------|
| `skillId`      | 是   | 技能ID，叮当平台分配   | `String` |32|
| `userToken` | 是   | 合作方用户身份标识，可为登录态token或用户id | `String` |-|
| `details` | 是   | 商品详情列表，字段定义参见商品详情，如:[{"itemId":"123456","quantity":1,"amount":100}] | `Array` |-|
| `totalAmt`      | 是   | 订单总金额（必须等于商品详情列表金额之和），以分为单位 | `Long`   |-|
| `nonceStr`      | 是   | 随机字符串             | `String` |32|

**商品详情**

| 参数            | 必填 | 描述                   | 类型         |最大长度|
| --------------- | ---- | ---------------------- | ------------ |--------|
| `itemId` | 是   | 合作方商品id，唯一标识商品 | `String` |32|
| `quantity` | 是 | 商品数量 | `Int` |-|
| `amount`      | 是   | 金额，以分为单位 | `Long`    |-|

**返回参数：**

| 参数      | 必填 | 描述                                  | 类型         |最大长度|
| --------- | ---- | ------------------------------------- | ------------ |----------------|
| `retCode` | 是   | 返回码, SUCCESS/FAIL，SUCCESS表示成功 | `String`  |8|
| `retMsg`  | 否   | 错误描述                              | `String`|32|

**以下字段在retCode为SUCCESS时返回**

| 参数      | 必填 | 描述                                                         | 类型         |最大长度|
| --------- | ---- | ------------------------------------------------------------ | ------------ |------------------|
| `tradeNo` | 是   | 合作方订单号，需要保证唯一， 要求32个字符内，只能是数字、大小写字母 | `String` |32|



### 2 通知发货

用户支付成功后，叮当会通知合作商发货给用户，合作商需要接收处理，并返回应答。

对后台通知交互时，如果叮当收到合作商的应答不是成功或者超时，叮当认为通知失败，叮当会通过一定的策略定期重新发起通知，尽可能提高通知的成功率，但叮当不保证通知最终能成功。

***注意：同样的通知可能会多次发送给合作商系统。合作商系统必须能够正确处理重复的通知。***

**接口链接：合作方提供**

**请求方法：post**

 **参数说明：json格式**

| 参数            | 必填 | 描述                   | 类型         |最大长度|
| --------------- | ---- | ---------------------- | ------------ |---|
| `skillId`      | 是   | 技能ID，叮当平台分配   | `String` |32|
| `userToken` | 是   | 合作方用户身份标识，可为登录态token或用户id | `String` |-|
| `transactionId` | 是   | 叮当平台交易流水号     | `String` |32|
| `tradeNo`       | 是   | 合作方订单号          | `String` |32|
| `totalAmt`      | 是   | 订单总金额，以分为单位 | `Long`    |-|
| `nonceStr`      | 是   | 随机字符串             | `String` |32|


**返回参数：**

合作方处理发货通知参数后，同步返回给叮当

| 参数      | 必填 | 描述                                                        | 类型         |最大长度|
| --------- | ---- | ----------------------------------------------------------- | ------------ |-------|
| `retCode` | 是   | 返回码, SUCCESS/FAIL，SUCCESS表示商户接收通知成功并校验成功 | `String`  |8|
| `retMsg`  | 否   | 错误描述                                                    | `String` |32|




### 3 查询订单

 **接口链接：https://aiwx.html5.qq.com/paycgi/orderquery**

**请求方法：post**

 **参数说明：json格式**

| 参数            | 必填   | 描述                                               | 类型         |最大长度|
| --------------- | ------ | -------------------------------------------------- | ------------ |------|
| `skillId`      | 是     | 技能ID，叮当平台分配                               | `String` |32|
| `transactionId` | 二选一 | 叮当平台交易流水号。`transactionId，tradeNo`二选一 | `String` |32|
| `tradeNo`       | 二选一 | 合作方订单号。`transactionId，tradeNo`二选一        | `String` |32|
| `version`      | 否    | 版本号，默认为1.0                                      | `String` |5|
| `nonceStr`      | 是     | 随机字符串                                         | `String` |32|

**返回结果：**

| 参数      | 必填 | 描述                                  | 类型         |最大长度|
| --------- | ---- | ------------------------------------- | ------------ |----|
| `retCode` | 是   | 返回码，SUCCESS/FAIL，SUCCESS表示成功 | `String`  |8|
| `retMsg`  | 否   | 错误描述                              | `String` |32|


**以下字段在retCode为SUCCESS时返回**

| 参数              | 必填 | 描述                                                         | 类型         |最大长度|
| ----------------- | ---- | ------------------------------------------------------------ | ------------ |-----|
| `skillId`        | 是   | 技能ID，叮当平台分配                                         | `String` |32|
| `transactionId`   | 是   | 叮当平台交易流水号                                           | `String` |32|
| `tradeNo`         | 是   | 合作方订单号                                                 | `String` |32|
| `totalAmt`        | 是   | 订单总金额，以分为单位                                       | `Long`    |-|
| `tradeStatus`     | 是   | 订单状态， NOTPAY 未支付，PROCESSING支付中，SUCCESS支付成功，FAIL支付失败 | `String` |16|
| `tradeStatusDesc` | 是   | 订单状态描述                                                 | `String` |16|



### 4 申请退款

 **接口链接：https://aiwx.html5.qq.com/paycgi/refund**

**请求方法：post**

 **参数说明：json格式**

| 参数            | 必填   | 描述                   | 类型         |最大长度|
| --------------- | ------ | ---------------------- | ------------ |------|
| `skillId`      | 是     | 技能ID，叮当平台分配   | `String` |32|
| `transactionId` | 二选一 | 叮当平台交易流水号。`transactionId，tradeNo`二选一 | `String` |32|
| `tradeNo`       | 二选一 | 合作方订单号。`transactionId，tradeNo`二选一 | `String` |32|
| `refundTradeNo` | 是     | 合作方退款订单号，需保证唯一， 要求32个字符内，只能是数字、大小写字母 | `String` |32|
| `totalAmt`      | 是     | 订单总金额，以分为单位 | `Long`    |-|
| `refundAmt`     | 是     | 退款总金额，以分为单位 | `Long`   |-|
| `refundDesc`    | 否     | 退款原因描述           | `String` |64|
| `refundDetails` | 是   | 退款商品详情列表，字段定义参见商品详情，如:[{"itemId":"123456","quantity":1,"amount":100}] | `Array` |-|
| `version`      | 否    | 版本号，默认为1.0                                      | `String` |5|
| `nonceStr`      | 是     | 随机字符串             | `String` |32|

**返回结果：**

| 参数      | 必填 | 描述                                                  | 类型         |最大长度|
| --------- | ---- | ----------------------------------------------------- | ------------ |---|
| `retCode` | 是   | 返回码，SUCCESS/FAIL，SUCCESS表示叮当平台受理退款申请 | `String`  |8|
| `retMsg`  | 否   | 错误描述                                              | `String` |32|

**以下字段在retCode为SUCCESS时返回**

| 参数                  | 必填 | 描述                   | 类型         |最大长度|
| --------------------- | ---- | ---------------------- | ------------ |---|
| `skillId`            | 是   | 技能ID，叮当平台分配   | `String` |32|
| `transactionId`       | 是   | 叮当平台交易流水号     | `String` |32|
| `tradeNo`             | 是   | 合作方订单号           | `String` |32|
| `refundTransactionId` | 是   | 叮当平台退款订单号     | `String` |32|
| `refundTradeNo`       | 是   | 合作方退款订单号       | `String` |32|
| `totalAmt`            | 是   | 订单总金额，以分为单位 | `Long`    |-|
| `refundAmt`           | 是   | 退款总金额，以分为单位 | `Long`    |-|



### 5 查询退款

 **接口链接：https://aiwx.html5.qq.com/paycgi/refundquery**

**请求方法：post**

 **参数说明：json格式**

| 参数                  | 必填   | 描述                 | 类型         |最大长度|
| --------------------- | ------ | -------------------- | ------------ | ------------ |
| `skillId`            | 是     | 技能ID，叮当平台分配 | `String` |32|
| `refundTransactionId` | 二选一 | 叮当平台退款订单号。`refundTransactionId，refundTradeNo`二选一 | `String` |32|
| `refundTradeNo`       | 二选一 | 合作方退款订单号。`refundTransactionId，refundTradeNo`二选一 | `String` |32|
| `version`      | 否    | 版本号，默认为1.0                                      | `String` |5|
| `nonceStr`            | 是     | 随机字符串           | `String` |32|


**返回参数：**

合作方处理退款结果通知参数后，同步返回给叮当

| 参数      | 必填 | 描述                                  | 类型         |最大长度|
| --------- | ---- | ------------------------------------- | ------------ |---|
| `retCode` | 是   | 返回码，SUCCESS/FAIL，SUCCESS表示成功 | `String`  |8|
| `retMsg`  | 否   | 错误描述                              | `String` |32|

**以下字段在retCode为SUCCESS时返回**

| 参数                  | 必填 | 描述                                                       | 类型         |最大长度|
| --------------------- | ---- | ---------------------------------------------------------- | ------------ |---|
| `skillId`            | 是   | 技能ID，叮当平台分配                                       | `String` |32|
| `transactionId`       | 是   | 叮当平台交易流水号                                         | `String` |32|
| `tradeNo`             | 是   | 合作方订单号                                               | `String` |32|
| `refundTransactionId` | 是   | 叮当平台退款订单号                                         | `String` |32|
| `refundTradeNo`       | 是   | 合作方退款订单号                                           | `String` |32|
| `totalAmt`            | 是   | 订单总金额，以分为单位                                     | `Long`    |-|
| `refundAmt`           | 是   | 退款总金额，以分为单位                                     | `Long`    |-|
| `refundStatus`        | 是   | 退款状态， PROCESSING退款中，SUCCESS退款成功，FAIL退款失败 | `String` |16|
| `refundStatusDesc`    | 是   | 退款状态描述                                               | `String` |16|



### 6 退款结果通知

此接口非必须，CP可以通过定时调用退款接口查询退款状态。 

**接口链接：合作方提供**

**请求方法：post**

 **参数说明：json格式**

| 参数                  | 必填 | 描述                                                       | 类型         |最大长度  |
| --------------------- | ---- | ---------------------------------------------------------- | ------------ |---------|
| `skillId`            | 是   | 技能ID，叮当平台分配                                       | `String` |32|
| `transactionId`       | 是   | 叮当平台交易流水号                                         | `String` |32|
| `tradeNo`             | 是   | 合作方订单号                                               | `String` |32|
| `refundTransactionId` | 是   | 叮当平台退款订单号                                         | `String` |32|
| `refundTradeNo`       | 是   | 合作方退款订单号                                           | `String` |32|
| `totalAmt`            | 是   | 订单总金额，以分为单位                                     | `Long`    |-|
| `refundAmt`           | 是   | 退款总金额，以分为单位                                     | `Long`    |-|
| `refundStatus`        | 是   | 退款状态， PROCESSING退款中，SUCCESS退款成功，FAIL退款失败 | `String` |16|
| `refundStatusDesc`    | 是   | 退款状态描述                                               | `String` |16|
| `nonceStr`            | 是   | 随机字符串                                                 | `String` |32|


**返回参数：**

合作方处理退款结果通知参数后，同步返回给叮当

| 参数      | 必填 | 描述                                                        | 类型         |最大长度|
| --------- | ---- | ----------------------------------------------------------- | ------------ | ------------ |
| `retCode` | 是   | 返回码，SUCCESS/FAIL，SUCCESS表示商户接收通知成功并校验成功 | `String`  |8|
| `retMsg`  | 否   | 错误描述                                                    | `String` |32|
